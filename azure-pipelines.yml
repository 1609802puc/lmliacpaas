trigger:
- main

pool:
  name: Default_2
  demands:
    - Agent.Name -equals ag001

variables:
  resourceGroupName: rg-iac-webapp
  location: centralus
  templateFile: 'arm-templates/webapp-template.json'
  parametersFile: 'arm-templates/webapp-parameters.json'

  # ⚠️ NOME EXATO DO WEB APP (igual ao Portal Azure)
  webAppName: 'lmliacpaas001-qvq7mwuoeku4k'

stages:
# =========================================================
# STAGE 1 - DEPLOY DA INFRAESTRUTURA (ARM)
# =========================================================
- stage: DeployInfrastructure
  displayName: 'Deploy Infra (ARM)'
  jobs:
  - job: ARM_Deployment
    displayName: 'ARM Deployment'
    steps:
    - checkout: self

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy ARM - WebApp'
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'ar01com'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourceGroupName)'
        location: '$(location)'
        templateLocation: 'Linked artifact'
        csmFile: '$(templateFile)'
        csmParametersFile: '$(parametersFile)'
        deploymentMode: 'Incremental'
        deploymentName: 'webapp-deployment'

# =========================================================
# STAGE 2 - DEPLOY DO SITE HTML
# =========================================================
- stage: DeployApp
  displayName: 'Deploy App (HTML)'
  dependsOn: DeployInfrastructure
  jobs:
  - job: Publish_HTML
    displayName: 'Publish HTML to WebApp'
    steps:
    - checkout: self

    # -----------------------------------------------------
    # Compacta o conteúdo HTML (PASTA src)
    # -----------------------------------------------------
    - task: ArchiveFiles@2
      displayName: 'Zip site (src)'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/src'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/site.zip'
        replaceExistingArchive: true

    # -----------------------------------------------------
    # Deploy via Azure CLI (COM BYPASS DE SSL)
    # -----------------------------------------------------
    - task: AzureCLI@2
      displayName: 'Deploy ZIP via Azure CLI (config-zip)'
      inputs:
        azureSubscription: 'ar01com'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host ">>> Desabilitando verificação SSL (proxy corporativo)"
          $env:AZURE_CLI_DISABLE_CONNECTION_VERIFICATION = "1"

          Write-Host ">>> Publicando site no Azure Web App"
          az webapp deployment source config-zip `
            --resource-group "$(resourceGroupName)" `
            --name "$(webAppName)" `
            --src "$(Build.ArtifactStagingDirectory)\site.zip"

          Write-Host ">>> Deploy finalizado com sucesso"
